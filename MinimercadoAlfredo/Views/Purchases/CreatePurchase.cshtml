@using Newtonsoft.Json
@model MinimercadoAlfredo.Models.Product

@{
    ViewBag.Title = "Nueva Compra";
}
<head>


</head>
@*///////////////////////////*@

<input value="@ViewBag.msg" id="msg" style="display: none" />
<h3 class="text-center hidden-print" style="margin-bottom: 5px;">
    Nueva Compra
</h3>
<hr style="margin-top: 10px;
    margin-bottom: 10px;" />

<legend style="margin-bottom: 2px;">
    Datos Generales
</legend>
<table class="table table-condensed table-bordered">
    <thead>
    <tr class="text-center" style="color: white; background-color: #4d77a3">
        <th class="text-center">
            N° Compra
        </th>
        <th class="text-center">
            Proveedor
        </th>
        <th class="text-center">
            Fecha
        </th>
    </tr>
    </thead>
    <tbody>
    <td class="text-center">
        <span>@ViewBag.npurchase</span>
    </td>
    <td class="text-center">
        <select class="js-example-basic-single inputForm" id="providername" style="font: small-caption; width: 180px; height: 25px; background-color: beige;">
            <option value="0">Seleccionar Proveedor...</option>
            @foreach (var item in ViewBag.Providers)
            {
                <option value="@item.IdProvider">@item.ProviderName</option>
            }
        </select>
        <span class="error">Requerido</span>
    </td>
    <td class="text-center">
        <input type="date" class="panel-info form-control inputForm" id="purchasedate" placeholder="dd/mm/aaaa"/>
        <span class="error">Requerido</span>
    </td>
    </tbody>

</table>
<legend style="margin-bottom: 2px;">
    Listado Productos
</legend>
<table id="mytable" class="table table-condensed table-bordered">
    <thead>
        <tr class="text-center" style="color:white; background-color:#4d77a3">
            <th class="text-center">
                Producto
            </th>
            <th class="text-center">
                Precio
            </th>
            <th class="text-center">
                Cantidad
            </th>
            <th class="text-center">
                Total
            </th>
            <th class="text-center">
                Acción
            </th>
        </tr>
    </thead>
    <tbody id="last">
    <td>
        @* <input type="text" class="panel-info" style="width: 130px;height:25px;" id="linedescription" />*@
        @*<div id="ajaxBeginFormResult">*@
        <select class="js-example-basic-single" id="linedescription" style="font: small-caption; width: 200px; height: 25px; background-color: beige; display: inline-block" onchange="javacript: var valor = this.options[selectedIndex].text; document.getElementById('shadow').value = valor;">
            <option value="0">Seleccionar Producto...</option>
            @foreach (var item in ViewBag.Products)
            {
                <option value="@item.IdProduct">@item.ProductNumber - @item.ProductDescription</option>
            }
        </select>
        @*<a class="btn btn-warning btn-xs" data-toggle="modal" data-target="#myModal" style="padding-right: 6px; padding-left: 6px; padding-top: 4px; padding-bottom: 4px">
            <span class="glyphicon glyphicon-plus text-center"></span>
        </a>*@
        @*</div>*@
        <input type="hidden" id="shadow" value="">
        <span class="error">Requerido</span>
    </td>
    <td>
        <input type="text" class="panel-info form-control inputForm" value="0" style="width: 130px; height: 25px;" id="lineprice" onchange="totallinea()" oninput="totallinea()" onkeypress="solonumerosptocoma()" />
        <span class="error">Requerido</span>
    </td>
    <td>
        <input type="number" class="panel-info form-control inputForm" value="1" style="width: 130px; height: 25px;" id="linequantity" onchange="totallinea()" oninput="totallinea()" onkeypress="solonumerosptocoma()"/>
        <span class="error">Requerido</span>
    </td>
    <td>
        <input type="text" class="panel-info text-center totalView dataContainer" value="0.00" id="linetotal" readonly="readonly" />
        <span class="error">Requerido</span>
    </td>
<td>
        <button type="button" id="add" class="btn btn-success btn-sm " value="Agregar" style="bottom:auto" />Agregar
        <span class="glyphicon glyphicon-plus"></span>
    </td>
    </tbody>
</table>

<div>
    <div id="orderItems">
    </div>
    <span class="error"></span>

</div>

<legend style="margin-bottom: 2px;">
    Resumen
</legend>
<table class="table table-striped table-bordered table-condensed">

    <thead>
        <tr class="text-right" style="color: white; background-color: #4d77a3">
            <td class="text-center" style="border-radius: 3px; font-weight: bold">
                Observaciones
            </td>
            <td class="text-center" style="border-radius: 3px; width: 200px; font-weight: bold">
                Total
            </td>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>
                        <textarea type="text" style="width: 300px;" class="panel-info form-control" id="comments" placeholder=""></textarea>

            </td>
            <td>
                <input type="text" class="panel-info text-center totalView dataContainer" value="0.00" id="purchasetotal" placeholder="" readonly="readonly" />
                <span class="error">Requerido</span>
            </td>
        </tr>

    </tbody>

</table>




<hr />

<div class="text-center">
    <button type="button" id="submit" class="btn btn-success btn-md" value="Guardar compra">
        Guardar
        <span class="glyphicon glyphicon-floppy-disk"></span>
    </button>
   

</div>



<link href="@Url.Content("~/Content/Select2/select2.min.css")" rel="stylesheet" />
@section Scripts{
    <script src="@Url.Content("~/Scripts/solonumeros.js")"></script>
    <script src="@Url.Content("~/Scripts/solonumerosptocoma.js")"></script>



    <script src="@Url.Content("~/Content/Select2/select2.js")"></script>
    <script>
        function totallinea() {
            var price = parseFloat($('#lineprice').val());
            var quantity = parseFloat($('#linequantity').val());
            var total = (price * quantity);
            document.getElementById("linetotal").value = total.toFixed(2);
        }

        function NroExistente() {

            if ($('#ProductNumber').val() != "") {

                var options = {};
                options.url = '@Url.Action("ExisteNro", "Products")';
                options.type = "GET";
                options.data = { "nombre": $("#ProductNumber").val() };
                options.dataType = "json";
                options.success = function (data) {
                    if (data) {
                        $('#nroexistente').text("Número de articulo existente");
                        $("#botonGuardar").prop("disabled", true);
                    } else {
                        $('#nroexistente').text("");
                        $("#botonGuardar").prop("disabled", false);

                    };


                };
                $.ajax(options);

            }

        }

        function ProdExistente() {

            if ($('#ProductDescription').val() != "") {

                var options = {};
                options.url = '@Url.Action("ExisteProd", "Products")';
                options.type = "GET";
                options.data = { "nombre": $("#ProductDescription").val() };
                options.dataType = "json";
                options.success = function (data) {
                    if (data) {
                        $('#productoexistente').text("Producto existente");
                        $("#botonGuardar").prop("disabled", true);
                    } else {
                        $('#productoexistente').text("");
                        $("#botonGuardar").prop("disabled", false);

                    };


                };
                $.ajax(options);

            }

        }





        function OnSuccess() {
            $("#myModal .close").click();
            $('.modal-backdrop').remove();

       
        }
        /////////////////Start:Select searchable////////////////
        $(document).ready(function () {
            if ($('#msg').val() == 1) { toastr.success("Compra guardada correctamente."); }
            $(".js-example-basic-single").select2();
        });
        ////////////////End:Select searchable///////////////////

     

        //////////////////////Start: Autocomplete Product Price/////////////
        $(document).ready(function() {
            $("#linedescription").change(function() {

                var options = {};
                options.url = "/Purchases/Getproductdata";
                options.type = "GET";
                options.data = { "pro": $("#linedescription").val() };
                options.dataType = "json";
                options.success = function(data) {
                    document.getElementById("lineprice").value = data;
                    totallinea();
                };
                $.ajax(options);

            });
        });
        ///////////////////End: Autocomplete Product Price////////

        //////////////////Start: LinePrice Calculation//////////////
        $(document).ready(function() {
            $("#linequantity").change(function() {
                    var price = parseFloat($('#lineprice').val());
                    var quantity = parseFloat($('#linequantity').val());

                    var total = price * quantity;

                    document.getElementById("linetotal").value = total;


                }
            );
        });


        $('#linetotal').click(function () {
            var price = parseFloat($('#lineprice').val());
            var quantity = parseFloat($('#linequantity').val());
            var total = price * quantity;
            document.getElementById("linetotal").value = total;
        });

        ////////////////////End: LinePrice Calculation/////////////

     

        $(document).ready(function() {
            var orderItems = [];
            var verifproductos = [];
            var totgral = [];
            //Add button click function
            $('#add').click(function() {
                //Check validation of order item
                var isValidItem = true;
                if ($('#linedescription').val().trim() == '' || $('#linedescription').val().trim() == '0') {
                    isValidItem = false;
                    $('#linedescription').siblings('span.error').css('visibility', 'visible');
                } else {
                    $('#linedescription').siblings('span.error').css('visibility', 'hidden');
                }

                if ($('#lineprice').val().trim() == '') {
                    isValidItem = false;
                    $('#lineprice').siblings('span.error').css('visibility', 'visible');
                } else {
                    $('#lineprice').siblings('span.error').css('visibility', 'hidden');
                }


                if ($('#linequantity').val().trim() == '') {
                    isValidItem = false;
                    $('#linequantity').siblings('span.error').text('Requerido');
                    $('#linequantity').siblings('span.error').css('visibility', 'visible');
                } else {
                    if ($('#linequantity').val().trim() * 1 == 0) {
                        isValidItem = false;
                        $('#linequantity').siblings('span.error').text('Valor min: 1');

                        $('#linequantity').siblings('span.error').css('visibility', 'visible');
                    } else {
                        $('#linequantity').siblings('span.error').css('visibility', 'hidden');
                    }
                }
                if ($('#linetotal').val().trim() == '') {
                    isValidItem = false;
                    $('#linetotal').siblings('span.error').css('visibility', 'visible');
                } else {
                    $('#linetotal').siblings('span.error').css('visibility', 'hidden');
                }
                if (isValidItem) {
                    ////////////***********//////////
                    var historial = verifproductos;
                    var errorproductos = false;
                    productoact = parseInt($('#linedescription').val().trim());
                    $.each(historial, function () {
                        if (productoact == parseInt(this)) {
                            errorproductos = true;

                        }
                    });
                }
                if (errorproductos) {
                    isValidItem = false;
                    bootbox.alert({
                        title: "Producto existente",
                        message: "El producto: - " + $('#shadow').val().trim() + " - ya se encuentra en el listado. ",
                        backdrop: true
                    });
                }
                //Add item to list if valid
                if (isValidItem) {
                    orderItems.push({
                        IdProduct: $('#linedescription').val().trim(),
                        LinePrice: $('#lineprice').val().trim(),
                        LineQuantity: $('#linequantity').val().trim(),
                        LineTotal: $('#linetotal').val().trim(),
                        LineDescription: $('#shadow').val().trim()
                    });
                    verifproductos.push(
                              parseInt($('#linedescription').val().trim())
                          );
                    totgral.push(
                             parseFloat($('#linetotal').val().trim())
                         );
                    //Clear fields
                  
                    $("#linedescription").val(0).trigger('change');
                    $('#lineprice,#linequantity,#linetotal').val('0.00');
                    $('#linequantity').val('1');


                }
                //populate order items
                GeneratedItemsTable();

            });
            //Save button click function
            $('#submit').click(function() {
                //validation of order
                var isAllValid = true;
                if (orderItems.length == 0) {
                    $('#orderItems').html('<span style="color:red;">Por favor, agregue productos.</span>');
                    isAllValid = false;
                }
                if ($('#providername').val().trim() == '' || $('#providername').val().trim() == '0') {
                    $('#providername').siblings('span.error').css('visibility', 'visible');
                    isAllValid = false;
                } else {
                    $('#providername').siblings('span.error').css('visibility', 'hidden');
                }
              

                if ($('#purchasetotal').val().trim() == '') {
                    $('#purchasetotal').siblings('span.error').css('visibility', 'visible');
                    isAllValid = false;
                } else {
                    $('#purchasetotal').siblings('span.error').css('visibility', 'hidden');
                }
                if ($('#purchasedate').val().trim() == '') {
                    $('#purchasedate').siblings('span.error').css('visibility', 'visible');
                    isAllValid = false;
                } else {
                    $('#purchasedate').siblings('span.error').css('visibility', 'hidden');
                }

                //Save if valid
                if (isAllValid) {
                    var data = {
                        ProviderName: $('#providername').val().trim(),
                        //Sorry forgot to add Description Field
                        PurchaseDate: $('#purchasedate').val().trim(),
                        PurchaseTotal: $('#purchasetotal').val().trim(),
                        Comments: $('#comments').val().trim(),
                        PurchaseLines: orderItems
                    }

                    $(this).val('Please wait...');

                    $.ajax({
                        url: '@Url.Action("CreatePurchase", "Purchases")',
                        type: "POST",
                        data: JSON.stringify(data),
                        dataType: "JSON",
                        contentType: "application/json",
                        success: function(d) {
                            //check is successfully save to database
                            if (d.status == true) {
                                var url = '@Url.Action("CreatePurchase", "Purchases", new { x = 1 })';
                                window.location.href = url;
                            } else {
                                alert('Failed');
                            }
                            $('#submit').val('Save');
                        },
                        error: function() {
                            alert('Error. Please try again.');
                            $('#submit').val('Save');
                        }
                    });
                }

            });

//function for show added items in table
            function GeneratedItemsTable() {
                $('.elim').remove();

                if (orderItems.length > 0) {
                    $('#orderItems').html('<span style="color:red;"></span>');
                  
                    $.each(orderItems, function(i, val) {
                        var $row = $('<tr class="elim"  style="background-color: white"></tr>');
                        $row.append($('<td></td>').html(val.LineDescription));
                        $row.append($('<td></td>').html(val.LinePrice));
                        $row.append($('<td></td>').html(val.LineQuantity));
                        $row.append($('<td></td>').html(val.LineTotal));
                        var $remove = $('<a href="#">Eliminar</a>');

                        //CALCULO TOTAL GRAL
                        purchasetotal = 0;
                        $.each(totgral, function () { purchasetotal += parseFloat(this) || 0; });
                        document.getElementById("purchasetotal").value = purchasetotal.toFixed(2);

                        $remove.click(function(e) {
                            e.preventDefault();
                            verifproductos.splice(i, 1);
                            totgral.splice(i, 1);
                            orderItems.splice(i, 1);
                            GeneratedItemsTable();
                            purchasetotal = 0;
                            $.each(totgral, function () { purchasetotal += parseFloat(this) || 0; });
                            document.getElementById("purchasetotal").value = purchasetotal.toFixed(2);
                        });
                        $row.append($('<td></td>').append($remove));
                        $('#mytable > tbody:last').append($row);
                    });
                   
                } else {
                    $('#orderItems').html('');
                }
            }
        });

    </script>
}

<style>
    /*Adding some css for looks good*/
    span.error {
        display: block;
        visibility: hidden;
        color: red;
        font-size: 90%;
    }


    /*css for table*/
    .container td {
        vertical-align: top;
    }

    .tablecontainer table {
        width: 100%;
        border-collapse: collapse;
        border-top: 1px solid #BFAEAE;
        border-right: 1px solid #BFAEAE;
    }

    .tablecontainer th {
        border-bottom: 2px solid #BFAEAE !important;
    }

    .tablecontainer th, .tablecontainer td {
        text-align: left;
        border-left: 1px solid #BFAEAE;
        padding: 5px;
        border-bottom: 1px solid #BFAEAE;
    }

    .ui-widget {
        font-size: 12px !important;
    }
</style>